- Grafana 是一个强大的开源数据可视化和分析工具，它可以让你把各种数据源（比如 Prometheus）里的数据，以美观的图表形式展示出来。用于监控服务的指标。
- Grafana 负责**展示和分析** Prometheus 存储的数据。它可以从 Prometheus 查询数据，并以图表、仪表盘等形式展示出来，让你更直观地理解系统状态。
- dashboad 包含了多个 panel
- #### 核心概念
	- **数据源 (Data Source):** Grafana 连接的后端数据存储，在这里就是 Prometheus。
	- **仪表盘 (Dashboard):** 由一个或多个面板（Panel）组成的集合，通常用于监控一个特定的应用或系统。
	- **面板 (Panel):** 仪表盘中的一个独立的可视化组件，比如一个折线图、一个表格或一个单值显示。
- 第一步：安装：
	- ```
	  docker run -d -p 3000:3000 --name=grafana grafana/grafana-oss
	  ```
	- 运行成功后，在浏览器中访问 `http://localhost:3000`，你将看到 Grafana 的登录界面。默认的用户名和密码都是 `admin`，首次登录后会提示你修改密码。
- 第二步：添加数据源
	- Grafana 本身不存储数据，它需要连接到外部的数据源才能获取数据。最常见的数据源是 Prometheus，它专门用于收集时序数据（比如服务的 CPU 使用率、内存占用、请求延迟等）。
	- connection、data source、找到Prometheus，添加url，如果在容器内，用特别的地址。
	- http://host.docker.internal:9090
	- Save & test
- 第三步：创建你的第一个仪表盘和面板
	- 点击左侧导航栏的 **Dashboards** 图标，然后选择 **New Dashboard**。
	- 点击 **Add new panel**。
	- 一个仪表盘由一个或多个面板（Panel）组成，每个面板都用来展示特定类型的数据。
	- 在出现的面板编辑界面中，你可以：
		- **选择数据源**：在 **Query** 选项卡下，选择你之前配置好的数据源。
		- **编写查询语句**：根据你选择的数据源类型，编写相应的查询语句来获取数据。例如，如果你使用 Prometheus 作为数据源，你需要用 PromQL 来查询指标。
		- **选择可视化类型**：在 **Visualization** 选项卡下，选择合适的图表类型，如 **Graph**（折线图）、**Stat**（单值展示）、**Table**（表格）或 **Bar chart**（柱状图）等。
		- **配置面板设置**：在其他选项卡中，你可以自定义面板的外观，比如设置标题、X/Y 轴的单位、图例、阈值等。
		- 输入关注的指标数据（指标名或表达式，给面板取名，选择合适的**可视化类型**（比如 Graph），调整图表样式，然后Apply
- grafana dashboard 网站上有很多现成的仪表盘，导入 id 就可以使用了。
-
- 需要监控多台服务器的场景
	- ### 方法一：使用变量（Variables）
		- 你可以创建一个变量，比如叫做 `hostname`，让它动态地代表不同的服务器。
		- 只需要维护一个仪表盘，所有服务器的数据都可以通过切换变量来查看，极大地减少了重复工作。
-
- 变量
	- name 这是你在查询中引用的变量名
	- **Type**: 选择 `Query`。说明：表示这个变量的值将通过查询数据源（我们的 Prometheus）来动态获取。***Type**: `Query` (变量的值将从一个数据源查询中获取)
	- **Label**: 填写 `NPU ID`。说明：这是显示在仪表盘下拉菜单前的友好名称。***Label**: `Instance` (这是下拉菜单显示的名称，可以自定义)
	- **Include All option**: 启用（点一下开关）。
		- *说明：在下拉菜单中自动添加一个 "All" 选项，方便一次性查看所有 NPU 的聚合数据。*
	- **Multi-value**: 启用（点一下开关）。
		- *说明：允许用户同时选择多个 NPU ID。*
	- query type：
		- **从 Prometheus 获取**变量**的下拉列表内容。
		- 你不需要自己从零手写复杂的 PromQL，而是选择一个“查询类型”，然后填入简单的参数，Grafana 会在背后帮你生成正确的 PromQL 查询。
		- **Label names** 获取所有**标签的名称**，
		- Label values 获取某个特定**标签 (Label) 的所有不重复的值 (Value)**。
		- Metrics：获取所有**指标名称 **
		- Query result：**最灵活，也是最原始**的方式。它不使用任何快捷方式，直接让你填写一个标准的 PromQL 查询，然后从查询返回的结果中提取值。
		- **`Label values`**获取**标签的值****创建筛选器** (如选择 NPU、选择主机)⭐⭐⭐⭐⭐`Metrics`获取**指标的名称**动态切换图表内容 (如在功耗/温度间切换)⭐⭐⭐`Label names`获取**标签的名称**探索数据，仪表盘中很少用⭐`Query result`运行完整查询处理复杂逻辑 (如只显示“在线”主机)⭐⭐
	- ## 详细步骤：创建 NPU ID 变量
	  
	  Here's how to set it up step-by-step in Grafana's variable settings page.
		- ### 1. 进入变量设置
		- 在你的仪表盘页面，点击右上角的**齿轮图标 ⚙️** (Dashboard settings)。
		- 在左侧菜单中选择 **"Variables"**。
		- 点击 **"Add variable"**。
		  
		  ---
		- ### 2. 核心配置：设置 Query Type 和相关选项
		  
		  This is where you'll answer your question. Follow these settings precisely.
		- **General**
			- **Name**: `npu_id` (这是内部引用的名字, e.g., `$npu_id`)
			- **Type**: `Query`
			- **Label**: `NPU ID` (这是显示在下拉菜单上的名字)
		- **Query Options**
			- **Query type**: 从下拉菜单中选择 **`Label Values`** (标签值)。
				- **💡 为什么选这个?** 因为你的目标是获取**标签 `id` 的所有值** (`0`, `1`, `2`, etc.)。`Label Values` 这个类型就是专门干这个的。
			- **Data source**: 选择你的 **Prometheus** 数据源。
			- **Metric**: 在这个输入框里，填入一个包含 `id` 标签的指标。用 `npu_chip_info_health_status` 就很完美。
			  
			  <!----><!----><!----><!----><!----><!---->
			  
			  <!---->
			  
			  ```
			  npu_chip_info_health_status
			  ```
			  
			  <!----><!----><!---->
			  
			  <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
				- **💡 为什么填这个?** 我们需要告诉 Grafana 去哪里寻找 `id` 标签，任何一个包含所有 NPU 卡 `id` 的指标都可以作为“例子”。
			- **Label**: 在这个输入框里，直接填入你要获取的标签名。
			  
			  <!----><!----><!----><!----><!----><!---->
			  
			  <!---->
			  
			  ```
			  id
			  ```
			  
			  <!----><!----><!---->
			  
			  <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---->
		- ### 3. 预览并保存
		- 完成以上设置后，向下滚动到页面底部。
		- 在 **Preview of values** (值预览) 部分，你应该能清楚地看到 `0, 1, 2, 3, 4, 5, 6, 7`。
		- 这证明你的配置完全正确！
		- (推荐) 在 **Selection Options** 中，打开 **Multi-value** 和 **Include All option**。
		- 点击 **`Add`** (如果是新建) 或 **`Update`** (如果是修改) 按钮，然后**保存**你的仪表盘。
	- ## 总结：你刚刚做了什么？
		- 通过上面的设置，你其实是在用图形化界面告诉 Grafana：
		  
		  > 
		  
		  “你好 Grafana，请使用我的 **Prometheus** 数据源。帮我查看一下 **`npu_chip_info_health_status`** 这个指标，找到名叫 **`id`** 的标签，然后把它所有不重复的值都拿来给我当下拉菜单的选项。”
		  
		  现在你就有了一个名为 `$npu_id` 的变量，可以在你所有的面板查询中使用了！例如：`npu_chip_info_temperature{id=~"$npu_id"}`。
	- Grafana 如何处理多选变量
		- 需要知道当你从下拉菜单中选择时，Grafana 是如何将 `$npu_id` 这个变量替换到查询语句里的：
		- **当你选择一个 ID 时 (例如 `3`)**
			- Grafana 会把 `$npu_id` 替换成：`3`
			- 你的查询语句变成：`npu_chip_info_temperature{id="3"}`
			- Prometheus 理解这个语句，意思是“找到 `id` 标签**精确等于** `3` 的数据”。这能正常工作。
		- **当你选择多个 ID 时 (例如 `3` 和 `5`)**
			- Grafana 为了能一次性查询多个值，会把 `$npu_id` 替换成一个**正则表达式格式**的字符串：`(3|5)`
			- 你的查询语句就变成了：`npu_chip_info_temperature{id="(3|5)"}`
			- **问题就在这里！** 对于 Prometheus 来说，`=` 是**精确匹配**，它会去寻找一个 `id` 标签的值**恰好就是** `"(3|5)"` 这个字符串，但这样的数据根本不存在，所以 Prometheus 返回“空空如也”，Grafana 自然就显示 "No Data" 了。
		- ### 解决方案：使用正则匹配操作符  `=~`
		  
		  `=~` 这个操作符告诉 Prometheus：“请把右边的字符串当作一个**正则表达式**来匹配左边的标签”。
		- 当你使用 `=~` 时，你的查询语句变成了：`npu_chip_info_temperature{id=~"(3|5)"}`
		- Prometheus 收到这个指令后，就会正确地去寻找 `id` 标签的值是 `3` **或者** `5` 的所有数据。这样就能正常工作了！
		- 只要一个 Grafana 变量开启了 "Multi-value" (多选) 或 "Include All option" (全选)，那么在 Prometheus 查询语句中，就必须对这个变量使用 `=~` (正则匹配)，而不是 `=` (精确匹配)。
		- **复用性 (Reusability / D.R.Y.)**: **D**on't **R**epeat **Y**ourself。创建一个“模板化”的仪表盘，可以轻松地应用于不同的环境（开发/生产）、不同的服务、不同的主机，而无需复制粘贴和修改几十个面板。
- JSON
	- **`"title"`**: 仪表盘的标题，和你看到的一样。
	- **`"uid"`**: **极其重要**。这是仪表盘的**唯一标识符**。当你通过 API 更新仪表盘时，Grafana 就是通过 `uid` 来找到它的。如果你想用同一个 JSON 创建一个**新**的仪表盘，**必须把 `uid` 改成 `null` 或一个全新的值**。
	- `"schemaVersion"`: Grafana 内部的版本号，用于处理旧版仪表盘的迁移。**你永远不要手动修改它**。
	- templating list 是变量区
	- `panels` 是面板区。里面的每一个对象都代表一个面板
		- `targets` 是查询语句
		- **查询修改**: 真正的数据来源在 `panel.targets[n].expr` 字段里。
	- **创建副本的秘诀**: 导入前，**必须把 `uid` 设为 `null`**，否则会覆盖掉原始仪表盘。
	- 导入
		- 修改数据源 UID (关键一步)，
			- *（如何查找？进入 Grafana 的数据源设置页面，点击你的 Prometheus，URL 末尾的那串字符就是它的 UID。）*
		-
-
- 为什么 exporter /metrics 的 instance 和 Prometheus 抓取入库后的 instance 不一致？
	- 这是因为 Prometheus 的标签覆盖（Label Overwriting）机制。
	- Prometheus 服务器在抓取数据时，默认会用它自己的抓取目标地址来覆盖掉指标原始的 `instance` 标签。Prometheus 这样做主要是为了保证监控目标的唯一性。以帮助你识别数据的来源。
	- /metrics 里的 instance是 Exporter 程序自己定义的标签，这是指标的“出厂”状态。
	- Prometheus 里的 instance 是是 Prometheus 抓取这个 Exporter 时所使用的“网络地址”。
	- 当 Exporter 暴露的指标中已经存在一个名为 instance 的标签时，Prometheus 的默认行为是用自己生成的 instance 标签（即抓取地址）去覆盖 Exporter 的原始标签。
	- 在将数据存入自己的时序数据库之前，它用抓取目标的地址**覆盖**了原始的 `instance` 标签。
	- 一个网络地址 (`ip:port`) 在网络中是唯一的，但 Exporter 自己定义的名称 (如 `npu-exporter-136`) 不一定是。
	- 通过用网络地址作为 `instance` 标签，Prometheus 能确保它抓取的每一个目标都有一个绝对唯一的标识。代表了数据的网络来源地址。这在定位问题时至关重要，能让你准确知道是哪一个服务实例出了问题。
	- 这是一个标准且有用的行为，因为它能确保 `instance` 标签在整个监控系统中的一致性，始终代表着一个唯一的、可访问的网络端点。
	-
-
- 1
	- `label_values(npu_chip_info_health_status_gauge{instance="$instance"}, id)`
	- 这句话的意思是：“**请从我选定的 `$instance` 中，找到名为 `npu_chip_info_health_status_gauge` 的指标，然后把这个指标里所有不重复的 `id` 标签的值都列出来。**”
	- **`label_values( ... , ... )`**
	- 这是一个 PromQL 函数，它的作用是**获取某个标签（label）所有不重复的值**。它有两个参数：第一个是指标，第二个是标签名。
	- **`npu_chip_info_health_status_gauge{...}`**
	- 这是第一个参数，代表你要查询的指标。
	- `{instance="$instance"}` 是一个**过滤器**。还记得我们创建的第一个变量 `$instance` 吗？这里的 `$instance` 会被替换成你在 Grafana 仪表盘下拉菜单中选择的值。所以，这句的意思是 “只查找来自当前选定实例的指标数据”。
	- **`id`**
	- 这是第二个参数，它告诉 `label_values` 函数，我们想要获取的标签是名为 "id" 的标签。
	- **总结一下整个流程：**
		- 当你从第一个下拉菜单中选择一个 `instance`（比如 `host.docker.internal:9090`）时，Grafana 就会向 Prometheus 发送这个查询。Prometheus 会：
		- 找到所有 `instance` 为 `host.docker.internal:9090` 的 `npu_chip_info_health_status_gauge` 指标。
		- 查看这些指标，发现它们分别有 `id="0"`, `id="1"`, `id="2"`, ..., `id="7"` 等标签。
		- 将这些不重复的 `id` 值 (`0, 1, 2, 3, 4, 5, 6, 7`) 返回给 Grafana。
		- Grafana 用这些返回的值填充我们刚刚创建的 `$id` 下拉菜单。
-
- ### `Legend`  (图例)
	- 自定义图例的显示格式
	- 这是用来**自定义图表中每条线的名称**的。
	- 默认情况下，Grafana 会显示一个很长的、原始的指标名称，例如 `cpu_usage_user{cpu="cpu0", instance="server1"}`。这非常不直观。通过在 `Legend` 输入框中使用模板，我们可以把它变得更简洁易读。
	- 用 `{{label_name}}` 这样的语法。例如，输入 `CPU User {{cpu}}`，图例就会显示成 `CPU User cpu0`, `CPU User cpu1` 这样清晰的名称。
	- ### `Min step`  (最小步长)
		- **这是什么？**
		  这个选项强制 Grafana 在向 Prometheus 查询数据时，两个数据点之间的**最小时间间隔**。
	- ### `Format`  (格式)
	- **这是什么？**
	  这个选项决定了 Prometheus 返回的数据以**何种数据结构**交给面板来渲染。
-
- **类型是 `gauge`**：这表示它的值是一个瞬时读数，可以上升也可以下降，就像汽车的速度表一样。
-
- 阈值
	- 它的逻辑是设置一个个“台阶”或“门槛”值，颜色会应用到**大于或等于**这个值的区间。
	- **设置基础色为“危险色”**
		- 在你截图的界面里，把第一行的 **`Base` (基础色)** 设置为 **`Red` (红色)**。这是默认颜色，当数值不满足任何其他阈值条件时就会显示它。
	- **添加“健康”状态的阈值**
		- 点击 **"Add threshold"** 添加一个阈值台阶。
		- 在这个新的规则里，输入数字 **`1`**，然后把颜色选为 **`Green` (绿色)**。
-
- 值映射
	- `Value Mappings` 的作用就是把你从查询中得到的原始数字（比如 `1` 或 `0`）“翻译”成你想要显示的任何文本和颜色。
-
- #### **Text mode (文本模式)**
	- 这个选项决定了面板上**显示哪些文字信息**。
	- `Auto` (自动): 默认选项，Grafana 会自动决定显示什么。
	- `Value` (值): 只显示最终的数值或映射后的文本（例如 "OK" 或 "Down"）。
	- **`Name and value` (名称和值)**: **(推荐)** 同时显示系列名称（来自 Legend 图例，例如 "Health 0"）和值（例如 "OK"）。这是信息最全的选项。
	- `Name` (名称): 只显示系列名称。
	- `None` (无): 不显示任何文本，只有一个变色的背景（如果你配置了颜色）。
-
- #### **Color mode (颜色模式)**
  
  这个选项决定了阈值或值映射设置的颜色**应用在哪个地方**。
	- `Value` (值): 只给文本本身上色。
	- **`Background` (背景)**: **(推荐)** 将整个面板的背景都涂上颜色。这种方式视觉冲击力最强，可以让你在扫视整个仪表盘时，第一时间发现变为红色的异常模块。
-