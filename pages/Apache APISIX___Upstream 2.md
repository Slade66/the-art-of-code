- 上游是你的后端服务集群。它定义了 APISIX 应该将请求转发到哪里。一个上游可以包含一个或多个后端服务节点，这些节点通常是相同的服务实例，用于分担流量。
- **作用:** 上游定义了“请求应该被转发到哪里”。
- 解决了什么问题：
	- 假设你有 10 个不同的路由（`/api/user`, `/api/orders`, `/api/products`...），但这 10 个路由都需要转发到**同一组后端服务器**。如果有一天，这组服务器里要新加一台机器，你就必须手动去修改**全部 10 个路由**的 `upstream` 配置，非常繁琐且容易出错。
- #### 设置 upstream 的方式
	- **直接在 Route 中设置**（将 `upstream` 直接写在 `route`）
		- 这是一种“一体化”的配置。路由规则和后端服务地址被写在同一个配置块里，**不需要**单独去创建一个 `upstream` 对象。
		- **优点**：
			- **简洁直观**：对于一个路由只对应一个后端服务的场景，这是最简单、最清晰的方式。所有信息都在一个地方，一目了然。
			- **配置独立**：每个路由的后端配置都是独立的，修改一个路由的 `upstream` 不会影响任何其他路由。
		- **适用场景**：
			- 一个特定的 API 路径 (`/generate`) 只会转发到一个特定的后端服务 (`10.30.80.223:1025`)。
			- 大多数独立的、简单的 API 代理。
	- #### 单独创建 Upstream，Route 中引用
		- 这是一种“分体式”或“可复用”的配置。
		- **第一步**：你先创建一个独立的 `upstream` 对象，给它一个ID（比如 `my-backend-servers`），并在里面定义好后端服务的地址列表。
		- **第二步**：你在创建 `route` 的时候，不写具体的 `upstream` 内容，而是用 `upstream_id: "my-backend-servers"` 来引用那个已经创建好的 `upstream` 对象。
		- **优点**：
			- **方便复用**：如果你有 10 个不同的路由（`/api/a`, `/api/b`, `/api/c`...），它们都需要转发到**同一组后端服务器**。你只需要创建一个 `upstream` 对象，然后在 10 个路由里都引用它就行了。
			- **易于维护**：未来如果这组后端服务器需要增加或减少机器，你只需要修改那一个独立的 `upstream` 对象，所有引用它的 10 个路由就都自动生效了，而不需要一个一个去改路由。
		- **适用场景**：
			- 多个路由共享同一组后端服务的微服务架构。
			- 需要对一组后端服务进行精细化管理（如健康检查、负载均衡策略等）的复杂场景。
- nodes
	- `nodes` 是什么？有什么用？
		- **`nodes` 就是你的后端服务实例 (service instances) 的地址集合**。当你配置一个 Upstream 时，必须通过 `nodes` 参数（或者 `service_name` 进行服务发现）告诉 APISIX 流量应该转发到哪里去。
		- `nodes` 参数中不仅包含服务节点的 IP 地址和端口，还可以为其定义**权重 (weight)** 和**优先级 (priority)**，这些信息会被负载均衡器使用。
		- 用于定义上游服务（即你的后端服务）的节点列表。APISIX 网关会根据配置的负载均衡算法 (load balancing algorithm) 将客户端请求转发到这个列表中的某个节点上。
	- `nodes` 的取值范围
	  collapsed:: true
		- `nodes` 参数支持两种主要的配置格式：**对象格式 (Object/Hash Table)** 和 **对象数组格式 (Array of Objects)**。
		- 对象格式
			- 适用于只需要配置地址和权重的简单场景。
			- **结构**: 一个键值对 (key-value) 形式的 JSON 对象。
				- **键 (Key)**: 节点的地址，格式为 `"host:port"`。
					- 如果 `host` 是 IPv6 地址，则必须用方括号 `[]` 括起来，例如 `"[::1]:80"`。
				- **值 (Value)**: 节点的权重 (weight)，是一个非负整数（即大于或等于 0 的整数）。权重越高的节点会接收到更多的流量（具体取决于所选的负载均衡算法）。
					- 正整数
						- 这个数值本身没有绝对的单位，它是一个**相对值**，用于计算该节点在所有节点中应该接收流量的比例。
						- 例如，有两个节点，A 的权重是 `100`，B 的权重是 `50`。在轮询类 (`roundrobin`) 负载均衡算法下，A 接收到的流量大约会是 B 的两倍。这与将它们的权重设置为 `2` 和 `1` 的效果是完全一样的。
					- 零
						- 当一个节点的权重为 `0` 时，负载均衡器通常**不会将任何新的请求流量转发给它**。
						- 这是一种常见的操作，用于将某个服务节点“优雅下线” (gracefully drain) 或进行维护，即在不从配置中删除该节点的情况下，暂时将其移出活跃的节点池。
					- 负数
						- 权重不支持负数。负数作为权重在负载均衡的上下文中没有实际意义。节点的优先级 (priority) 可以是负数，但权重不行。
					- 小数
						- **不支持小数**，因为权重的核心作用是定义不同节点之间接收流量的**比例 (ratio)**，任何可以用小数表示的比例，都可以通过等比放大的方式用整数来表示。
			- **示例：**
				- ```json
				  "nodes": {
				          "192.168.1.100:8080": 100,
				          "192.168.1.101:8080": 50
				      }
				  ```
				- 在这个例子中，定义了两个上游节点。`192.168.1.100:8080` 的权重是 `100`，`192.168.1.101:8080` 的权重是 `50`。在 `roundrobin` 算法下，前者的流量大约会是后者的两倍。
		- 对象数组格式
			- 这种格式功能更强大，除了地址和权重，还允许你为每个节点配置**优先级 (priority)**。
			- **结构**: 一个 JSON 数组，数组中的每个元素都是一个描述节点的 JSON 对象。
				- 每个对象可以包含以下字段：
					- `host`: (字符串, **必需**) 节点的 IP 地址或域名。
					- `port`: (整数, **可选**) 节点的端口。
					- `weight`: (整数, **必需**) 节点的权重。
					- `priority`: (整数, **可选**) 节点的优先级，默认为 `0`。
						- **优先级数值越小，优先级越高**。
						- APISIX 会优先将请求发往优先级最高的节点组。只有当该组所有节点都不可用时，才会尝试下一个优先级组的节点。
						- 可以设置负数作为优先级，常用于配置备份节点 (backup nodes)。
			- 示例：
				- ```json
				  "nodes": [
				    { "host": "192.168.1.100", "port": 8080, "weight": 100, "priority": 0 },
				    { "host": "192.168.1.101", "port": 8080, "weight": 100, "priority": 0 },
				    { "host": "192.168.1.200", "port": 8080, "weight": 1, "priority": -10 }
				  ]
				  ```
				- 在这个例子中：
					- 前两个节点 (`192.168.1.100` 和 `192.168.1.101`) 的优先级都是 `0`，它们是主服务节点，APISIX 会在这两个节点之间根据权重进行负载均衡。
					- 第三个节点 (`192.168.1.200`) 的优先级是 `-10`，它是一个备份节点。只有当前面两个主节点都无法访问时，APISIX 才会将流量转发到这个备份节点。
	- **格式：`"IP或域名:端口": 权重`**
	- **不需要** `http://` 前缀
	- IPv6（需要用方括号包围）
-